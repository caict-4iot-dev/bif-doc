# 2.星火链开发入门

本章厘清几个星火链开发必须知道的基础概念、工具和设计。

```eval_rst
.. important::
    Solidity中有一些内置的密码学算法（如：keccak256/sha3等），当部署的FISCO BCOS区块为国密类型时，内置使用的是相应的国密算法（如：sm3等）
```

<p style="color: green;">This text will be green, regardless of the !important rule in CSS.</p>

## 2.1 基础术语

###  2.1.1 非对称加密

在区块链系统中，非对称加密技术是实现身份验证和数据完整性校验的关键机制。它利用一对数学上相关联但不相同的密钥：公钥和私钥。

- 公钥是公开的，可以安全地与他人共享，用于验证数字签名。
- 私钥是保密的，仅被密钥的拥有者知晓，用于创建数字签名。

### 2.1.2 数字签名

数字签名是一种用于验证数字信息完整性和认证发送者身份的技术。它基于非对称加密原理，通过对数字信息进行加密和生成签名，使得除了信息的发送者之外的任何人都无法伪造签名。**星火链支持两种数字签名算法：SM2和ED25519**。

### 2.1.3 区块链

区块链是一种分布式数据库或账本技术，它以链式结构安全地存储数据记录。这些记录被称为“区块”，每个区块包含一系列[交易](#transaction)数据，并通过哈希指针的方式与前一个区块链接起来，形成一个不可篡改和连续的数据链。区块链的核心特点包括去中心化、不可篡改性、透明性和安全性。

### 2.1.4 区块链节点

区块链节点是一种运行区块链软件协议副本的设备，区块链系统是由多个区块链节点组成。


### 2.1.5  智能合约

智能合约指的是部署在区块链上通过[交易](#transaction)触发, 自动执行的代码逻辑，开发者能够利用星火链支持的编程语言，开发一个商业级别的智能合约。
**星火链支持`Solidity`, `Javascript`两种语言的智能合约。`Solidity`合约的生态工具更加完善且性能更佳，==官方推荐使用`Solidity`智能合约==**。

### 2.1.6  共识算法

区块链中的共识算法是一种机制，用于确保网络中所有参与节点就数据的状态和交易的有效性达成一致意见。**星火链中的共识算法使用的是创新的混合共识算法 ```DPOS + PBFT```**。

### 2.1.7 账号

也称账户(`account`)，星火链上的账户分为**外部账户**和**合约账户**。

- 外部账户

  外部账户是星火链的主体，是对现实社会中法人或自然人一种的映射。外部帐号的实质为通过非对称加密技术保护的一对公私钥, 拥有外部账户的用户可以使用其私钥对[交易](#transaction)进行签名，并通过发送签名的交易来管理账户。**只有被激活的外部账户才能在相互链上发起交易。**

- 合约账户

  合约账户是由智能合约代码控制的账户，没有对应的公私钥，通过发送交易到合约账户，可以调用智能合约的函数或触发合约中的其他逻辑。

### 2.1.8 交易

- 操作

​          操作（Opration）是星火链上记录和更新信息的基本单位，一次账号激活、次合约调用都是一笔操作。

   - 交易

     <a id="transaction"></a>交易（Transaction）是指在区块链上发起的对账号进行的一系列操作。**星火链上的一笔交易可以包含多笔操作，而且同一笔交易中的多个操作，要么同时成功，要么同时失败。**

   - 交易序列化

     序列化是指将对象的状态信息转换为可以存储或传输的形式的过程。交易序列化是指为了用私钥对交易签名，将交易对象进行序列化为字节码的过程。**星火链采用`Protocol Buffer 3`作为序列化协议**。

   - 交易费用

     为防止链上出现大量无效的交易，提高交易的上链成本，星火链设计为用户发送交易请求必须支付相应的[星火令](#XHT)作为交易费用。

  - 交易缓存
	交易在提交到区块链节点后，先进去交易缓存池，待到系统完成共识打包出块后把交易从交易池删除。

	```
	注意:: 星火链的交易池有超时时间，超时时间还没被处理的交易将会被丢弃，需要重新发起交易。超时时间目前为`10`分钟。
	```
  - 交易哈希
	交易被发送到交易缓存池后区块链节点会计算一个交易的哈希值作为交易的唯一索引返回，**交易的最终处理结果需等交易打包区块后通过该交易哈希异步查询确认**。
  - 交易打包
	交易打包是指区块链系统将交易从交易缓存池捞出来打包成区块的过程。**星火链系统依靠定时器每`1s`发起一轮共识来打包用于生成新区块的交易。打包时，从交易缓存池的头部开始有序抓取交易池的交易进行打包，星火链单笔交易最大1M, 一个区块最大容量为16M**。
  - 交易出块时间
	星火链的出块时间会动态调整，有交易的情况下`1秒`出一个块，空块时`1分钟`出一次块，遇到共识或者网络波动的情况下出块时间可能会稍微延长。

### 2.1.9 星火令

星火令是星火链上的“燃油费”, 在星火链上发起的交易需要耗费星火令, 星火链上账户必须持有一定的星火令才能使用星火链功能。
星火令的基础单位是星火萤，星火令与星火萤的单位转换关系：

1 星火令(XHT) = 10^8 星火萤(glowstone)

星火链上发起交易消耗星火令的规则将在智能合约部分详细介绍。（跳转链接到消耗星火令详细介绍）

### 2.1.10 主网和体验网

星火链作为许可公有链，是节点部署在全国各大城市，实际线上`7*24`小时运行着的区块链网络系统。其中主网是正式对外提供服务的生产环境，体验网供开发者体验对接。

## 2.2 基础工具

###  2.2.1 星火链RPC接口

星火链通过rpc的方式对提供区块查询、合约调用等服务，服务地址：（开放平台正式上线后关停）

- 主网:  尚未对外
- 体验网: [http://test.bifcore.bitfactory.cn]()

### 2.2.2 星火链消息订阅服务

除用户主动调用星火链的接口之外，星火链还提供了消息订阅服务。用户订阅了某个账户或者区块的消息之后，星火链就会实时的将对应账户或者区块的消息通过`Websocket`接口发送给订阅者。订阅服务地址：（开放平台正式上线后关停）

- 主网：尚未对外
- 体验网：[ws://test.bifcore.bitfactory.cn:7053]()

### 2.2.3 星火链SDK

星火链提供了基于多种语言的SDK（跳转到SDK介绍的页面）, 用来方便开发者程序调用星火链RPC接口。

### 2.2.4 星火链离线API

离线API主要是提供密码学和交易序列化等相关的本地API。（跳转到离线API介绍的页面）

### 2.2.5 星火链订阅工具

订阅工具提供了对星火链区块、交易订阅功能，详细设计见[订阅服务设计]()，同时还提供了[使用示例说明]()。

### 2.2.6 区块链浏览器

区块链浏览器提供了对账户, 交易, 合约的查询和跟踪等功能, 可以节省开发者的大量时间和精力。 （跳转到浏览器介绍的页面）

目前星火链体验网的浏览器地址为: 

* 主网:   [https://explorer.bitfactory.cn](https://explorer.bitfactory.cn)
* 体验网: [http://test-explorer.bitfactory.cn](http://test-explorer.bitfactory.cn)

### 2.2.7 Remix合约IDE星火插件

`Remix` 是用于智能合约开发的Web端集成开发环境 (IDE)。由于其操作简单、功能强大，成为智能合约开发者的首选开发工具，在区块链，特别是以太坊生态中有举足轻重的地位。**Remix合约IDE星火插件**是基于`Remix` IDE的星火链插件，基于此插件，开发者可以更加直观、便捷地在星火链上开发、测试和部署智能合约。详见[Remix IDE 介绍](#2112-remix合约ide星火插件)

### 2.2.8 星火链插件钱包

浏览器插件钱包是星火链提供的浏览器插件版本的钱包，用户可以使用浏览器插件钱包本地管理自己的私钥，和控制私钥对交易进行签名。 （跳转到插件钱包介绍的页面）

### 2.2.9 星火链开放平台

星火链开放平台是“星火链的入口”，是基于“星火·链网”的Web创新应用服务平台，提供链上节点服务RPC、底层链API、安全审计、数据分析等全生命周期服务，同时将区块链底层交互逻辑封装为增强型API、进一步提升开发效率，助力开发者及企业用户打造开放、多元的分布式商业形态。

星火链开放平台地址：https://bop.bitfactory.cn/home

## 2.3 基础设计

做星火链应用开发前, 需要了解下星火链的帐号、交易和费用等基础机制。

### 2.3.1 账户

每个星火链帐号都会有以下几个属性

- `address` 

  账户地址, 外部账户实质为公钥的编码转化的字符串，合约账户为按照一定规则生成的字符串。（说明账户地址的结构）

- `nonce`

  用来防止签名重放攻击，**新创建的账户nonce默认为0， 查询账户信息时不显示该字段**。详细使用说明见交易章节[nonce设计](#nonce)。

- `contract`

  合约账户特有，存放智能合约代码，外部账户没有该字段，可以表明一个帐户是否是合约帐户。

- `balance`

  账户余额, 用来发交易时支付"交易费"， 单位是星火莹。


### 2.3.2 交易

#### 2.3.2.1 交易结构

星火链上的交易包含的主要元素如下:
- `sourceAddress`

  交易发起地址, 由该地址来支付本次交易消耗的"交易费"。

- `nonce`

  交易序号, 同一个`sourceAddress`下的所有交易必须具有唯一的`nonce`序号, 星火链支持**递增**和**随机**两种`nonce`的交易，详见章节[nonce设计](#nonce)。

- `fee_limit`

  该交易的消耗"交易费"的上限, 防止因为合约实现不合理或不可预知原因导致交易消耗的"燃料费"过多超出预期。关于fee_limit的使用见[fee_limit使用建议](#fee_limit)。

- `gas`
    gas用来表示单个交易的计算成本, 不同的交易类型或合约指令gas成本不同，详见[星火链gas使用规则](#gas_rule)。

- `gas_price`
  指用户愿意为每单位`gas`支付的星火令数量, 默认填1即可，具体的规则见[燃料费消耗规则](#gas_gasprice)

- `operation`

  操作是交易中附带的具体动作，改变账号的原子单位。星火链支持多种不同类型的操作，一个交易，必定是包含了1个或多个操作。详见[操作说明](#operation)

 - 交易的基本结构
```
{
    "source_address":"xxxxxxxxxxx",//交易源账号，即交易的发起方
    "nonce_type":1,//0 递增nonce, 1随机nonce
    "nonce":2, //nonce值
    "max_ledger_seq":58540,//最晚处理的区块链高度，随机nonce使用
    "fee_limit" : 1000000, //愿为交易花费的交易费
    "gas_price": 1,//gas价格,填默认的1即可
    "metadata":"0123456789abcdef", //可选，用户自定义给交易的备注，16进制格式
    "operations":[
    {
       
    //根据不同的操作填写
    },
    {
    //根据不同的操作填写
    }
    ......
    ]
}
```
#### 2.3.2.2 操作说明
<a id="transaction"></a>星火链支持多种类的操作类型，不同的操作类型有不同的[操作码](#操作码说明)：
- 创建账号操作
	在执行其他操作之前必须首先创建账号。创建账号操作由其他已存在的账号申请执行。第一个账号是在星火链启动时内置生成的，也被成为创世账号。

- 设置metadatas操作
	`metadatas`每个账户都有一个matadatas字段，是一个键值对数据库，可以存储额外的账户信息。
- 部署合约操作
	在链上部署智能合约。
-  调用合约操作
	调用智能合约的某个方法。

#### 2.3.2.3 nonce设计

<a id="nonce"></a>基于账户体系的区块链中nonce值是为了防止重放攻击而设计的，每个账户下的不同交易的nonce都不可以重复。星火链中交易的nonce分为递增和随机nonce两种。用户在发起交易时自己决定使用递增或是随机nonce。

```
.. node::
递增nonce适合对某个账户下的多笔交易有顺序执行要求的场景，其他场景均建议使用随机nonce.
```

- 递增nonce

  一笔递增nonce的交易上链后，无论执行成功还是失败, 账号的`nonce`就会加1。当使用账号发起递增nonce交易时，需要指定该交易`nonce`，其值必须比当前账号的`nonce`大1, 如果账户发起的交易nonce值比账户nonce + 1值小，交易池会丢弃此交易，认为存在重放攻击；如果账户发起的交易nonce值比账户nonce + 1值大，交易在交易池中等待nonce +1 的交易，直到nonce连续被处理或者超时。

- 随机nonce

  随机nonce是为了提高交易执行的并发度，提升链的性能而设计，只需要在一定区块高度范围内实现nonce不重复即可。随机nonce的详细使用指南见[随机nonce使用指南]()

#### 2.3.2.4 交易费扣除规则（最新gas规则出来后修改）

  - `账户balance - 账户最低reserve_balance > fee_limit`

  - `账户balance - 账户最低reserve_balance > gas * gas_price`

  星火链上一笔交易星火令的扣除分为如下几个部分：

  ``` (操作的固定gas + 交易的字节花费的gas + 合约指令花费的gas) * gasprice```

  - 其中创建合约和升级合约的固定`gas = 1000000`， 其他操作的固定`gas = 0`
  - 交易字节花费的`gas = 交易字节数 * 1 星火萤(glowstone)`
  - `Js`合约指令花费的`gas` 为0，`solidity` 指令花费的`gas` 和以太坊一致

```
.. important::
    对于javascript合约, 系统会提前根据交易类型计算需要gas, 如果账户余额不足, 交易提交失败不予入链(交易失败会不会把gas都扣完？。
```

### 2.3.3 消息订阅(最新订阅服务上线后提供)

星火链对外提供订阅服务，客户端发布订阅消息，订阅成功后，服务端可以及时的把客户端订阅的事件信息发送给客户端。目前可以支持的有***\*区块订阅、区块头订阅、指定地址的交易订阅\****能力。