# 2.星火链开发入门

本节厘清几个星火链开发必须知道的入门概念和工具。

## 2.1 名词解释

### 星火令XHT

星火令是星火链的基础单位, 在星火链上发起的交易需要耗费星火令, 星火链上账户必须持有一定的星火令才能使用星火链功能。
星火令单位转换关系：

<center>
1XHT=10^8 uXHT
</center>

### 星火链智能合约

智能合约指的是部署在区块链上通过交易触发, 自动执行的代码逻辑，开发者能够利用星火链支持的编程语言，开发一个商业级别的智能合约。

目前星火链支持`javascript`, `solidity`两种语言的智能合约,`C++`智能合约支持正在内测中。

### 星火链SDK

星火链提供了基于多种语言的SDK [Github链接](https://github。com/CAICT-DEV/BIF-Core-SDK), 用来方便开发者程序与链上交互。

SDK提供功能包括:

* 创建账户
* 查询指定账户的信息
* 查询交易信息
* 部署合约
* 调用合约
* 查询合约

### 区块链浏览器

区块链浏览器提供了对账户, 交易, 合约的查询和跟踪等功能, 可以节省开发者的大量时间和精力。 目前星火链测试网的浏览器地址为: 

* 主网:   [https://explorer.bitfactory.cn](https://explorer.bitfactory.cn)

* 测试网: [http://test-explorer.bitfactory.cn](http://test-explorer.bitfactory.cn)

### 星火链RPC地址

* 主网:  **尚未对外**
* 测试网: [http://test.bifcore.bitfactory.cn]()

## 2.2 开发基础

做星火链应用开发前, 需要了解下星火链的帐号, 交易和费用等基础机制。

###  帐号

账号是星火链的主体，是对现实社会中法人或自然人一种的映射。

星火链帐号的实质为通过非对称加密技术保护的一对公私钥, 每个星火链帐号都会有以下几个属性

- `address` 

  账户地址, 实质为公钥的编码转化结果, 只有拥有私钥的用户才能使用对应地址发出交易。

- `nonce`

  每个账户从0开始的计数, 代表该账户发起的交易数量, 同时用来防止签名重放攻击。 当账号执行一笔交易入链后，无论交易成功还是失败, 账号的`nonce`就会加1。

  当使用账号发起交易时，需要指定该交易`nonce`，其值必须比当前账号的`nonce`大1, 当一个账号被新建时，它的`nonce`为0,关于nonce使用可参照**星火链进阶进阶使用-2.如何保障账号交易异步上链**章节。

- `contract`

  标明一个帐号是否是智能合约帐号。

- `balance`

  账户余额, 注意:每个账户至少要保留```0.1XHT```余额。

### 交易 transaction

交易广义的定义，它是一个对账号进行一系列操作的组合。

### 操作 operation

操作是交易中附带的具体动作，改变账号的原子单位。一个交易，必定是包含了1个或多个操作。

### 创建账号

账号为交易的主体，所有的交易必须通过账号发起执行。因此，在执行其他操作之前必须首先创建账号。创建账号操作由其他已存在的账号申请执行。第一个账号是在星火链启动时内置生成的，也被成为创世账号。

### 设置metadata

metadata是一个带版本的键值对数据库。它的每一个键值对，都有一个版本号，每当修改了这条数据，版本号就会自动加1。

### 设置权重

设置账户拥有者和签名者在源账号下的权重。

### 设置门限

设置源账号下各项操作的门限，如果交易中某项操作的权重没有达到该操作的门限值，该操作将被拒绝。

###  交易

星火链上的交易包含的主要元素如下:

- `sourceAddress`

  交易发出地址, 由该地址来支付本次交易耗费的星火令。

- `nonce`

  交易序号, 同一个`sourceAddress`下的所有交易必须具有唯一的`nonce`序号, 并且交易只能按照`nonce`从小到大按序入链, 中间不能有空。

- `fee_limit`

  该交易的费用上限, 防止因为不可预知原因或者bug,导致交易耗费过多超出预期。

- `gas_price`

  交易的`gas`价格, 详细参见下节。

### 交易费用

用户发送交易请求必须支付相应的交易费用，以填补区块链网络内计算机节点设备的折旧、电力、运维等成本。在星火链中，区块链费用可以在交易前评估，且评估不收取任何费用，以方便用户根据自身情况合理提供交易费用。此外，费用的标准也可以在区块链运行过程中根据实际需要选举修改。

### 交易耗费计算和检查

星火链上的所有交易都需要耗费星火令, 耗费的计算公式为```gas * gas_price```,单位为`uXHT`。

名词解释：

- `gas`

  gas用来表示单个交易的计算成本, 对于`javascript`合约, 每种交易类型的`gas`耗费固定, 对于`solidity`合约, 交易`gas`耗费是实际执行的各个op(操作码)的`gas`耗费之和。

- `gas_price`

  `gas_price`指用户愿意为每单位`gas`支付的`XHT`数量, 由用户自己在发出交易时指定。

星火链上每个区块的交易打包时, 会根据`gas_price`排序, `gas_price`越高的交易会排在前面优先执行。 同时每笔交易在打包前, 会检查下账户费用是否满足以下条件：

- `账户balance - 账户最低reserve_balance > fee_limit`

- `账户balance - 账户最低reserve_balance > gas * gas_price`

星火链上一笔交易星火令的扣除分为如下几个部分：

``` (操作的固定gas + 交易的字节花费的gas + 合约指令花费的gas) * gasprice```

- 其中创建合约和升级合约的固定`gas = 1000000`， 其他操作的固定`gas = 0`
- 交易字节花费的`gas = 交易字节数 * 1 uXHT`
- `Js`合约指令花费的`gas` 为0，`solidity` 指令花费的`gas` 和以太坊一致

注意:
```
对于javascript合约, 系统会提前根据交易类型计算需要gas, 如果账户余额不足, 交易提交失败不予入链。
```

### 调用合约

链上转账时触发智能合约里的函数。

###  交易哈希

交易是指在区块链中进行交换资产，在星火链中所有修改区块链数据的操作都称为交易，比如发送`gas`、创建账号、设置`metadata`、设置权限等都是交易，交易上链结果需等交易打包区块后通过该交易hash调用SDK交易查询接口确认。

###  签名信息

签名是指通过算法和私钥对交易数据进行加密确认并得到签名数据的过程。用户可以通过签名数据判断交易数据的完整性和正确性。

### 出块时间

有交易时3秒内，空块时1分钟。

###  交易缓存队列

区块链网络内任意一个节点收到一笔交易请求后，首先会对交易进行合法性检查。如果检查合法，则将此交易请求广播给其他节点，并将此请求加入到交易缓存队列中。**注意事项**：

- 交易池中存在一笔完全相同的交易（交易hash)一致，则直接插入失败。
- 某个源账户发的交易，`nonce`相同，其它参数存在差异（计算出的tx hash不同),则会比较两笔交易的`gasprice`，如果`B>=1.1A` ，则用B交易替换A交易；如果`B < 1.1A`，则提示`Drop the transaction to...`
- 目前星火链默认交易池处理超时时间为`10`分钟，超时则丢弃所有超时交易，需重新发起交易。

### 交易的打包

系统依靠定时器每`1s`发起一轮共识来打包用于生成新区块的交易。打包时，从交易缓存队列的头部开始有序抓取不超过`4M`字节的交易。如果遇到交易源账号序号断号的情况，将会从断号位置跳过该源账号请求的所有的交易，并标记该源账号断号位置，在断号补齐之前后续的区块也不会打包该源账号的交易，直到补齐断号，或者在交易缓存队列缓存超时被删除。

### 交易事务处理

同一笔交易中的所有操作，要么同时成功，要么同时失败，这被称为交易的原子性或者事务性。

### Tlog

tlog是星火链JS虚拟机（`JSVM`）日志基础设施提供的一个便利接口，提供的一种链内链外沟通的机制。类似于以太坊EVM虚拟机中的Event。

当合约调用`tlog`时，会触发参数存储到交易的日志中,通过触发事件智能合约可以通知链外组件某个交易动作是否触发完成。

## 2.3 交易流程

### 组装交易对象

根据意愿组装交易对象`Transaction`, 不同的交易有不同的数据结构。

### 序列化交易

很多地方都要用到序列化的功能。比如我们要对一笔交易签名，其实我们只能对字节串签名，这时就需要将交易序列化为字节串；还有我们需要存储交易，也需要序列化为字节流才能存储。我们选择了`Google`的`Protocol Buffer 3`协议进行序列化。由此我们的所有数据结构的定义都是用`Protocol Bbuffer 3` 定义的。`Protocol Buffer 3`的优点是速度快，占用空间小，有多种语言支持。我们统一用`SerializeAsString`表示对一个`protocol buffer`对象的序列化操作。

### 签名交易

用私钥`PrivateKey`对`transaction_blob`签名得到`sign_data`。

### 提交交易

向星火链发送交易请求，触发交易的执行。

### 查询交易是否执行成功

通过 SDK 查询交易状态以及交易回执。

## 2.4 Quicknode节点 

`Quicknode`节点是星火链网**测试网**上的快速部署节点，通过启动`Quicknode` `docker`服务与**测试网**节点建立连接，是接入星火开发生态的便捷途径。

`Quicknode`节点功能：开发者用户可以与“星火·链网”的**测试网**进行交互，实现新建账户、查询交易、部署合约和开发应用等功能。